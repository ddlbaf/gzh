define("pay/pay",["libs/template"],function(n,t,a){var e=n("libs/template");e.helper("fenToyuan",function(n){var t=Math.ceil(n/100);return t}),e.helper("dateFormate",function(n){return n.substring(0,10)}),e.helper("arrayToString",function(n){return n.join(",")});var o={iscroll:null,curType:1,type1:{data:null},type2:{data:null}},r=0,i={curNum:0,discount:0,data:{}},u={},c={bindEvent:function(){$("body").delegate(".js-tap",$.Func.TAP,function(n){var t=$(this).data("handler");c[t]&&c[t].call(this)}),window.onhashchange=function(){var n=location.hash.replace("#","");"coupon"==n?$("body").addClass("showCounpons"):$("body").removeClass("showCounpons")}},modifyTitle:function(n){if(n){var t=$("body");document.title=n;var a=$('<iframe src="/favicon.ico"></iframe>').on("load",function(){setTimeout(function(){a.off("load").remove()},0)}).appendTo(t)}},productInfo:function(n){var t=this,a={jsonrpc:"2.0",method:"Fund.ProductInfo",id:54321,params:{fundid:n}};$.Func.ajax(a,function(n){var a=n.result;if(a){i={curNum:0,data:a.goods};var o=i.data[i.curNum].productname+"信息服务";$("#title").html(o),t.modifyTitle(o),$("#totalPrice").html(a.goods[i.curNum].actualprice),r=a.goods[i.curNum].actualprice;var u=e("price-template",i.data[i.curNum]);$("#price").html(u),u=e("payment-template",a),$("#paymentList").html(u),t.checkCounpon()}})},reducePeriod:function(){var n=parseInt($("#period").val())||1,t=parseInt(i.discount);n>1&&(n--,$("#period").val(n),r=i.data[i.curNum].actualprice*n,$("#totalPrice").html(r.toFixed(2)-t))},addPeriod:function(){var n=parseInt($("#period").val())||1,t=parseInt(i.discount);n++,$("#period").val(n),r=i.data[i.curNum].actualprice*n,$("#totalPrice").html(r.toFixed(2)-t)},showPrice:function(){var n=$(this).data("productid"),t=$(this).data("number"),a=parseInt($("#period").val())||1;i.curNum=t,i.discount=0,c.checkCounpon(),$("#paymentList .js-tap").removeClass("on").eq(t).addClass("on"),$("#productid").val(n),r=i.data[t].actualprice*a,$("#totalPrice").html(r.toFixed(2));var o=e("price-template",i.data[t]);$("#price").html(o)},showCoupons:function(){var n=c;$.Func.getUserInfo(),$.User.wxgzh&&(location.hash="coupon",n.couponUserObtain(o.curType,function(t){o.type1.data=t.data,n.renderCoupon(t)}))},getCounpons:function(n){var t=this;$.Func.getUserInfo(),$.User.wxgzh&&(o.type1.data?$.isFunction(n)&&n(o.type1.data):t.couponUserObtain(o.curType,function(t){o.type1.data=t.data,$.isFunction(n)&&n(t.data)}))},checkCounpon:function(){var n=this,t=0,a=$("#productid").val();n.getCounpons(function(n){n&&$.each(n,function(e,o){~$.inArray(a,o.productsavailable)&&t++,e==n.length-1&&($("#coupon").val(t),$("#couponLink").html(t+"张可用"))})})},useCoupon:function(){var n=$(this).data("couponid"),t=$(this).data("productid").toString().split("."),a=i.data[i.curNum].productid.toString(),e=$(this).data("amount");~$.inArray(a,t)?(i.discount=+e,$("#coupon").val(n),$("#couponLink").html("优惠"+e+"元"),location.hash="coupon"):$.Func.pop("这张优惠券不能用在当前产品上！")},createOrder:function(n,t,a,e){var o={jsonrpc:"2.0",method:"Fund.CreateOrderGZH",id:54321,params:{userid:$.User.userid,openid:$.User.openid,productid:n,quantity:t,channelid:1,appenv:"weixin_gzh_nxb",couponid:a}};$.Func.ajax(o,function(n){var t=n.result;t&&e&&e(t)})},payWX:function(){var n=parseInt($("#productid").val()),t=parseInt($("#period").val())||1,a=n.toString()+"-"+t.toString(),e=parseInt($("#couponid").val())||0;return n?($("#btnLine").addClass("btnline-loading"),void(u.hasOwnProperty(a)?c.onpay(u[a]):c.createOrder(n,t,e,function(n){u[a]=n,c.onpay(n)}))):($.Func.pop("请选择产品支付"),!1)},onpay:function(n){wx.ready(function(){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:n.appId,timeStamp:n.timeStamp,nonceStr:n.nonceStr,"package":n["package"],signType:n.signType,paySign:n.paySign},function(n){"get_brand_wcpay_request:ok"==n.err_msg&&(location.href="pay_result.html?status=1&money="+r.toFixed(2)),$("#btnLine").removeClass("btnline-loading")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t),document.attachEvent("onWeixinJSBridgeReady",t)):t()})},showTab:function(){var n=c,t=$(this).data("type")||1;o.curType=t,$(this).parent().children().removeClass("on"),$(this).addClass("on"),o["type"+t].data?n.renderCoupon(o["type"+t]):n.couponUserObtain(o.curType,function(a){n.renderCoupon(a),o["type"+t].data=a.data})},couponUserObtain:function(n,t){uin=$.User.userid;var a={jsonrpc:"2.0",method:"Coupon.CouponUserObtain",id:54321,params:{userid:uin,type:n}};$.Func.ajax(a,function(n){var a=n.result;a&&$.isFunction(t)&&t(a)})},renderCoupon:function(n){o.iscroll||(o.iscroll=new IScroll("#wrapper")),n.data?$("#wrapper").removeClass("show-empty"):$("#wrapper").addClass("show-empty");var t=e("li-template",n);$("#couponList").html(t),o.iscroll.refresh()},closeLayer:function(){$(this).parent().parent().removeClass("show")},init:function(){$.Func.getUserInfo(),$.Func.getJSAPI();var n=$.Func.getParam("fundid");this.productInfo(n),this.bindEvent()}};a.exports=c});